<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üéÄ Alie's Name That Musical!</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400;1,700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:        #1a0a14;
  --bg2:       #261220;
  --bg3:       #32182a;
  --rose:      #e8547a;
  --rose2:     #f279a0;
  --rose3:     #fba8c4;
  --blush:     #fde8f0;
  --muted:     #9b7389;
  --border:    rgba(232,84,122,.18);
  --border2:   rgba(232,84,122,.40);
  --green:     #4ecca8;
  --red:       #ff6b7a;
  --r:         16px;
  --r2:        24px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html { font-size: 16px; -webkit-text-size-adjust: 100%; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--blush);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
}

/* Ambient background */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 70% 50% at 30% 0%, rgba(232,84,122,.22) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 80% 100%, rgba(248,120,160,.14) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 60% 50%, rgba(180,40,80,.08) 0%, transparent 50%);
  pointer-events: none;
}
/* Sparkle dots */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background-image:
    radial-gradient(1.5px 1.5px at 15% 20%, rgba(248,120,160,.5), transparent),
    radial-gradient(1px 1px at 55% 10%, rgba(232,84,122,.4), transparent),
    radial-gradient(2px 2px at 80% 35%, rgba(253,168,196,.35), transparent),
    radial-gradient(1px 1px at 25% 75%, rgba(248,120,160,.3), transparent),
    radial-gradient(1.5px 1.5px at 70% 80%, rgba(232,84,122,.4), transparent),
    radial-gradient(1px 1px at 90% 60%, rgba(253,168,196,.3), transparent);
  pointer-events: none;
}
body > * { position: relative; z-index: 1; }

/* ‚îÄ‚îÄ‚îÄ FIREBASE BANNER ‚îÄ‚îÄ‚îÄ */
#fb-banner {
  position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 9px 16px;
  font-size: .78rem; font-weight: 500; letter-spacing: .5px;
  transition: opacity .5s ease, transform .5s ease;
}
#fb-banner.connecting { background: rgba(26,10,20,.95); color: var(--muted); border-bottom: 1px solid var(--border); }
#fb-banner.connected  { background: rgba(10,40,30,.95); color: #4ecca8; border-bottom: 1px solid rgba(78,204,168,.3); }
#fb-banner.error      { background: rgba(60,10,20,.95); color: #ff9aaa; border-bottom: 1px solid rgba(255,107,122,.3); }
#fb-banner.hidden     { opacity: 0; transform: translateY(-100%); pointer-events: none; }
.fb-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
.fb-dot.pulse { animation: pulse 1.2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
.screen { display: none; min-height: 100vh; min-height: 100dvh; padding: 20px 14px 48px; padding-bottom: calc(48px + var(--safe-bottom)); }
.screen.active { display: flex; flex-direction: column; align-items: center; }
.pt-banner { padding-top: 56px; }

/* ‚îÄ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ‚îÄ */
.logo-wrap { text-align: center; }
.logo-eyebrow { font-size: .68rem; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.logo {
  font-family: 'Playfair Display', serif;
  font-size: clamp(2rem, 9vw, 3.6rem);
  font-weight: 900; line-height: 1;
  background: linear-gradient(135deg, var(--rose3) 0%, var(--rose) 50%, var(--rose2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-shadow: none;
  filter: drop-shadow(0 0 20px rgba(232,84,122,.3));
}
.logo em { font-style: italic; font-weight: 700; }
.logo-sub { color: var(--muted); font-size: .8rem; margin-top: 8px; letter-spacing: 1px; }
.logo-alie {
  font-family: 'Playfair Display', serif;
  font-size: .85rem; font-style: italic;
  color: var(--rose3); letter-spacing: 1px; margin-bottom: 4px;
}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 22px 18px;
  width: 100%; max-width: 440px;
  box-shadow: 0 16px 48px rgba(0,0,0,.45), inset 0 1px 0 rgba(232,84,122,.1);
}
.card-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.15rem; color: var(--rose2);
  margin-bottom: 18px; padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}

/* ‚îÄ‚îÄ‚îÄ FIELDS ‚îÄ‚îÄ‚îÄ */
.field { margin-bottom: 14px; }
.field label {
  display: block; margin-bottom: 6px;
  font-size: .68rem; letter-spacing: 2px;
  text-transform: uppercase; color: var(--muted);
}
.field input, .field select, .field textarea {
  width: 100%; padding: 13px 14px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: var(--r); color: var(--blush);
  font-family: 'DM Sans', sans-serif; font-size: .95rem;
  outline: none; transition: border-color .2s;
  -webkit-appearance: none;
}
.field input:focus, .field select:focus, .field textarea:focus { border-color: var(--rose); }
.field select option, .field select optgroup { background: var(--bg); }
.field textarea { resize: vertical; line-height: 1.55; min-height: 80px; }

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 7px;
  padding: 14px 22px; border-radius: var(--r);
  border: none; cursor: pointer;
  font-family: 'DM Sans', sans-serif; font-size: .9rem; font-weight: 600;
  letter-spacing: .3px; transition: all .18s;
  text-decoration: none; -webkit-tap-highlight-color: transparent;
}
.btn:disabled { opacity: .4; cursor: not-allowed; pointer-events: none; }
.btn:active { transform: scale(.97); }
.btn-full { width: 100%; }
.btn-pink {
  background: linear-gradient(135deg, var(--rose) 0%, var(--rose2) 100%);
  color: #fff;
  box-shadow: 0 4px 20px rgba(232,84,122,.4);
}
.btn-pink:hover { box-shadow: 0 8px 28px rgba(232,84,122,.55); transform: translateY(-1px); }
.btn-outline { background: transparent; border: 1px solid var(--border2); color: var(--blush); }
.btn-outline:hover { border-color: var(--rose); color: var(--rose2); }
.btn-ghost { background: transparent; color: var(--muted); }
.btn-ghost:hover { color: var(--blush); }
.btn-danger { background: var(--red); color: #fff; }
.btn-success { background: var(--green); color: #1a0a14; }
.btn-sm { padding: 9px 14px; font-size: .8rem; }

/* ‚îÄ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ‚îÄ */
#landing-screen { justify-content: center; gap: 0; }
#landing-screen .logo-wrap { margin-bottom: 44px; }
.role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 380px; }
.role-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r2); padding: 26px 14px;
  cursor: pointer; text-align: center;
  transition: all .2s; display: flex; flex-direction: column;
  align-items: center; gap: 10px;
  -webkit-tap-highlight-color: transparent;
}
.role-card:hover, .role-card:active { border-color: var(--rose2); transform: translateY(-3px); box-shadow: 0 12px 32px rgba(232,84,122,.2); }
.role-icon { font-size: 2.2rem; }
.role-label { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: var(--rose2); }
.role-desc { font-size: .75rem; color: var(--muted); line-height: 1.45; }

/* ‚îÄ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ‚îÄ */
.lobby-layout { display: flex; flex-direction: column; gap: 14px; width: 100%; max-width: 500px; }
.qr-wrapper { background: white; border-radius: 10px; padding: 10px; display: inline-block; }
.game-code-big {
  font-family: 'Playfair Display', serif;
  font-size: 2.8rem; letter-spacing: 10px;
  background: linear-gradient(135deg, var(--rose3), var(--rose));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-align: center; margin: 4px 0;
}
.player-chips { display: flex; flex-direction: column; gap: 8px; max-height: 260px; overflow-y: auto; }
.chip {
  display: flex; align-items: center; gap: 10px;
  background: var(--bg3); border-radius: 12px; padding: 10px 14px;
  animation: slideIn .25s ease;
}
@keyframes slideIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:none} }
.chip-av {
  width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
  background: linear-gradient(135deg, var(--rose) 0%, #8b2050 100%);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: .78rem; color: #fff;
}
.chip-name { font-weight: 500; font-size: .88rem; }
.chip-score { margin-left: auto; font-size: .8rem; color: var(--rose2); font-weight: 600; }
.no-players { color: var(--muted); font-size: .82rem; text-align: center; padding: 24px 0; }
.count-badge {
  background: rgba(232,84,122,.14); border: 1px solid var(--border);
  border-radius: 100px; padding: 3px 11px;
  font-size: .72rem; color: var(--rose2);
}

/* ‚îÄ‚îÄ‚îÄ HOST GAME ‚îÄ‚îÄ‚îÄ */
.game-layout { display: flex; flex-direction: column; gap: 14px; width: 100%; max-width: 500px; }

/* Auto song load status */
.auto-song-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r2); padding: 20px 18px;
  width: 100%; max-width: 500px;
}
.song-loading { text-align: center; padding: 16px; }
.song-loaded { }
.song-title-big {
  font-family: 'Playfair Display', serif;
  font-size: 1.35rem; color: var(--rose2);
  margin-bottom: 4px;
}
.song-musical-label { font-size: .8rem; color: var(--muted); margin-bottom: 14px; }

/* lyric cards */
.lyric-reveal-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px 18px;
  position: relative; transition: all .35s ease;
}
.lyric-reveal-card.revealed {
  border-color: rgba(232,84,122,.55);
  background: rgba(232,84,122,.07);
  animation: lyricReveal .35s ease;
}
@keyframes lyricReveal { from{transform:scale(.98);opacity:.6} to{transform:scale(1);opacity:1} }
.lyric-reveal-card.locked-card { opacity: .3; }
.lyric-num-row {
  display: flex; align-items: center; gap: 7px;
  margin-bottom: 8px;
  font-size: .67rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted);
}
.pt-chip {
  background: var(--rose); color: #fff;
  font-weight: 700; border-radius: 100px;
  padding: 2px 8px; font-size: .65rem;
}
.lyric-body {
  font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic; line-height: 1.65;
}
.lyric-hidden { font-size: .82rem; color: var(--muted); font-style: italic; }

.btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

/* submission list */
.sub-list { display: flex; flex-direction: column; gap: 7px; max-height: 220px; overflow-y: auto; }
.sub-item {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border-radius: 10px; padding: 9px 12px;
  font-size: .8rem; border-left: 3px solid transparent;
}
.sub-item.correct  { border-color: var(--green); }
.sub-item.wrong    { border-color: var(--red); }
.sub-item.pending  { border-color: var(--muted); }
.sub-name  { font-weight: 600; min-width: 70px; }
.sub-guess { color: var(--muted); flex: 1; font-size: .72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sub-pts   { font-weight: 700; color: var(--rose2); margin-left: auto; }

/* scoreboard */
.score-rows { display: flex; flex-direction: column; }
.score-row {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,.04);
}
.score-rank { font-size: .73rem; color: var(--muted); width: 18px; }
.score-pts  { font-weight: 700; color: var(--rose2); margin-left: auto; }

/* answer reveal */
.answer-box {
  background: var(--bg3); border-radius: var(--r); padding: 12px 14px; margin-bottom: 10px;
}
.a-label { font-size: .65rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 3px; }
.a-val { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--rose3); }

/* ‚îÄ‚îÄ‚îÄ PLAYER GAME ‚îÄ‚îÄ‚îÄ */
.player-game-wrap { width: 100%; max-width: 460px; display: flex; flex-direction: column; gap: 12px; }

.lyric-player-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); padding: 15px 16px;
  transition: all .4s ease;
}
.lyric-player-card.revealed {
  border-color: rgba(232,84,122,.55);
  background: rgba(232,84,122,.07);
  animation: lyricPop .4s ease;
}
@keyframes lyricPop { 0%{transform:scale(.97);opacity:.7} 60%{transform:scale(1.015)} 100%{transform:scale(1);opacity:1} }

.locked-box {
  background: rgba(78,204,168,.08); border: 1px solid rgba(78,204,168,.35);
  border-radius: var(--r); padding: 16px; text-align: center;
}
.locked-box .lbig { font-family: 'Playfair Display', serif; font-size: 1.05rem; color: var(--rose3); margin: 5px 0 2px; }
.locked-box .lsub { font-size: .75rem; color: var(--muted); }

/* ‚îÄ‚îÄ‚îÄ ROUND RESULT ‚îÄ‚îÄ‚îÄ */
.res-circle {
  width: 84px; height: 84px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; margin: 0 auto 14px;
}
.res-correct { background: rgba(78,204,168,.12); border: 2px solid var(--green); }
.res-wrong   { background: rgba(255,107,122,.12); border: 2px solid var(--red); }
.res-noans   { background: rgba(155,115,137,.1);  border: 2px solid var(--muted); }
.res-pts { font-family: 'Playfair Display', serif; font-size: 2.4rem; color: var(--rose2); margin: 0; }
.res-total { font-size: .8rem; color: var(--muted); margin-bottom: 16px; }

/* ‚îÄ‚îÄ‚îÄ LYRICS EDITOR ‚îÄ‚îÄ‚îÄ */
.editor-grid { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 12px; }
.song-row {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: var(--r); overflow: hidden;
}
.song-row-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; cursor: pointer; gap: 8px;
  border-bottom: 1px solid transparent; transition: border-color .2s;
}
.song-row-header.open { border-bottom-color: var(--border); }
.song-row-info { flex: 1; min-width: 0; }
.song-row-title { font-weight: 600; font-size: .88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-row-musical { font-size: .72rem; color: var(--muted); }
.song-row-status { font-size: .68rem; border-radius: 100px; padding: 3px 9px; flex-shrink: 0; }
.has-lyrics  { background: rgba(78,204,168,.1); color: #4ecca8; border: 1px solid rgba(78,204,168,.3); }
.no-lyrics   { background: rgba(255,107,122,.1); color: #ff9aaa; border: 1px solid rgba(255,107,122,.3); }
.song-row-body { display: none; padding: 14px; }
.song-row-body.open { display: block; }
.editor-filter {
  width: 100%; max-width: 600px;
  padding: 11px 14px; background: var(--bg2);
  border: 1px solid var(--border); border-radius: var(--r);
  color: var(--blush); font-family: 'DM Sans', sans-serif; font-size: .9rem; outline: none;
  margin-bottom: 8px;
}
.editor-filter:focus { border-color: var(--rose); }

/* ‚îÄ‚îÄ‚îÄ WAITING / ENDED ‚îÄ‚îÄ‚îÄ */
.spin {
  width: 52px; height: 52px; border-radius: 50%;
  border: 3px solid var(--border2); border-top-color: var(--rose);
  animation: spin 1.1s linear infinite; margin: 0 auto 22px;
}
@keyframes spin { to{ transform: rotate(360deg); } }
.podium-wrap { display: flex; align-items: flex-end; justify-content: center; gap: 10px; margin: 28px 0; max-width: 360px; }
.podium-col { flex: 1; border-radius: 12px 12px 0 0; text-align: center; padding: 14px 6px 12px; }
.p1 { background: linear-gradient(180deg,#e8547a,#8b2050); min-height: 140px; }
.p2 { background: linear-gradient(180deg,#9b6070,#5a2a3a); min-height: 100px; }
.p3 { background: linear-gradient(180deg,#cd7f9a,#7a3050); min-height: 72px; }
.p-medal { font-size: 1.5rem; }
.p-name  { font-weight: 700; font-size: .82rem; color: #fff; margin-top: 4px; }
.p-pts   { font-size: .72rem; color: rgba(255,255,255,.75); }

/* ‚îÄ‚îÄ‚îÄ UTIL ‚îÄ‚îÄ‚îÄ */
.sep { height: 1px; background: var(--border); margin: 14px 0; }
.muted { color: var(--muted); }
.small { font-size: .8rem; }
.center { text-align: center; }
.mt8  { margin-top: 8px; }
.mt14 { margin-top: 14px; }
.mt24 { margin-top: 24px; }
.w100 { width: 100%; }
.round-pill {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 100px; padding: 5px 16px;
  font-size: .78rem; color: var(--muted); margin-bottom: 14px;
}

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.overlay {
  position: fixed; inset: 0; z-index: 9000;
  background: rgba(0,0,0,.72); backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center; padding: 16px;
}
.overlay.hidden { display: none; }
.modal {
  background: var(--bg2); border: 1px solid var(--border2);
  border-radius: var(--r2); padding: 28px 22px; width: 100%; max-width: 360px;
  box-shadow: 0 24px 64px rgba(0,0,0,.6); text-align: center;
}
.modal-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--rose2); margin-bottom: 8px; }
.modal-sub   { font-size: .8rem; color: var(--muted); margin-bottom: 18px; }

/* ‚îÄ‚îÄ‚îÄ HOST REVEAL PROGRESS ‚îÄ‚îÄ‚îÄ */
.reveal-progress {
  display: flex; gap: 6px; margin-bottom: 14px;
}
.reveal-pip {
  flex: 1; height: 5px; border-radius: 10px;
  background: var(--border2); transition: background .3s;
}
.reveal-pip.active { background: linear-gradient(90deg, var(--rose), var(--rose2)); }

/* ‚îÄ‚îÄ‚îÄ AUTO NEXT STATUS ‚îÄ‚îÄ‚îÄ */
.auto-status {
  font-size: .78rem; color: var(--muted); text-align: center;
  padding: 8px; background: var(--bg3); border-radius: 10px;
  margin-top: 8px;
}
.auto-status span { color: var(--rose3); font-weight: 600; }

/* ‚îÄ‚îÄ‚îÄ PHONE SAFE AREAS ‚îÄ‚îÄ‚îÄ */
@media (max-width: 430px) {
  .card { padding: 18px 14px; }
  .game-code-big { font-size: 2.4rem; letter-spacing: 8px; }
  .logo { font-size: 2rem; }
  .btn-row { flex-direction: column; }
  .btn-row .btn { width: 100%; }
}
</style>
</head>
<body>

<!-- FIREBASE BANNER -->
<div id="fb-banner" class="connecting hidden">
  <div class="fb-dot pulse"></div>
  <span id="fb-banner-text">Connecting‚Ä¶</span>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 1: LANDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-landing" class="screen active pt-banner">
  <div class="logo-wrap mt24" style="margin-bottom:48px">
    <div class="logo-alie">‚ú® Alie's</div>
    <div class="logo-eyebrow">üéÄ trivia night</div>
    <div class="logo">Name That <em>Musical!</em></div>
    <div class="logo-sub">Guess the song from the lyrics</div>
  </div>
  <div class="role-grid">
    <div class="role-card" onclick="startHostLobby()">
      <div class="role-icon">üé¨</div>
      <div class="role-label">Host</div>
      <div class="role-desc">Run the game & reveal lyrics</div>
    </div>
    <div class="role-card" onclick="go('screen-join')">
      <div class="role-icon">üé§</div>
      <div class="role-label">Player</div>
      <div class="role-desc">Join &amp; guess the songs</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 2: PLAYER JOIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-join" class="screen pt-banner">
  <div class="logo-wrap" style="margin-bottom:28px">
    <div class="logo-alie">‚ú® Alie's</div>
    <div class="logo" style="font-size:1.7rem">Name That <em>Musical!</em></div>
  </div>
  <div class="card">
    <div class="card-title">üéü Join a Game</div>
    <div class="field">
      <label>Game Code</label>
      <input type="text" id="join-code" maxlength="6" placeholder="ABC12"
        style="text-transform:uppercase;letter-spacing:5px;font-size:1.3rem;text-align:center"
        oninput="this.value=this.value.toUpperCase()" inputmode="text" autocomplete="off" />
    </div>
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="join-name" maxlength="20" placeholder="Your nickname" autocomplete="nickname" />
    </div>
    <button class="btn btn-pink btn-full mt8" onclick="joinGame()">üéÄ Join Game</button>
    <div id="join-error" class="small center mt8" style="color:var(--red);display:none"></div>
    <div class="sep"></div>
    <button class="btn btn-ghost btn-full btn-sm" onclick="go('screen-landing')">‚Üê Back</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 3: HOST LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-host-lobby" class="screen pt-banner">
  <div style="width:100%;max-width:500px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
    <div>
      <div class="logo-alie" style="text-align:left">‚ú® Alie's</div>
      <div class="logo" style="font-size:1.4rem">Name That <em>Musical!</em></div>
    </div>
    <span class="count-badge">HOST</span>
  </div>
  <div class="lobby-layout">
    <div class="card">
      <div class="card-title">
        <span>üéÄ Lobby</span>
        <span class="count-badge" id="lobby-count">0 joined</span>
      </div>
      <div id="lobby-player-list" class="player-chips">
        <div class="no-players">Share the code ‚Äî players will appear here!</div>
      </div>
      <div class="sep"></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-pink" style="flex:1" onclick="startGame()">üé¨ Start Game</button>
        <button class="btn btn-outline btn-sm" onclick="go('screen-lyrics-editor')">‚úèÔ∏è Lyrics</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="justify-content:center;margin-bottom:12px">Game Code</div>
      <div class="game-code-big" id="lobby-code">‚Äî</div>
      <div class="small muted center" style="margin-bottom:12px">Players enter this to join</div>
      <div class="sep"></div>
      <div style="text-align:center;margin-bottom:10px">
        <div class="qr-wrapper"><div id="qrcode"></div></div>
      </div>
      <div id="join-url-text" class="small muted center" style="word-break:break-all;margin-bottom:10px"></div>
      <button class="btn btn-outline btn-sm btn-full" onclick="copyLink()">üìã Copy Join Link</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 4: HOST GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-host-game" class="screen pt-banner">
  <div style="width:100%;max-width:500px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <div class="logo" style="font-size:1.2rem">Name That <em>Musical!</em></div>
    <div class="round-pill" style="margin:0">Round <span id="host-round-num">1</span>/<span id="host-round-total">10</span></div>
  </div>

  <div class="game-layout">
    <!-- Random song status -->
    <div class="auto-song-card" id="auto-song-card">
      <div class="song-loading" id="song-loading">
        <div class="spin" style="width:36px;height:36px;margin-bottom:10px"></div>
        <div class="small muted">Loading a random song‚Ä¶</div>
      </div>
      <div class="song-loaded" id="song-loaded" style="display:none">
        <div class="small muted" style="margin-bottom:4px">üé≤ This round's song:</div>
        <div class="song-title-big" id="loaded-song-title">‚Äî</div>
        <div class="song-musical-label" id="loaded-song-musical">‚Äî</div>
        <div class="reveal-progress" id="reveal-progress">
          <div class="reveal-pip" id="pip-0"></div>
          <div class="reveal-pip" id="pip-1"></div>
          <div class="reveal-pip" id="pip-2"></div>
          <div class="reveal-pip" id="pip-3"></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-outline" id="reveal-next-btn" onclick="revealNext()" style="flex:1">üëÅ Reveal Next</button>
          <button class="btn btn-success" onclick="showAnswer()" style="flex:1">‚úÖ Answer</button>
        </div>
        <div id="host-lyrics-area" style="display:flex;flex-direction:column;gap:10px;margin-top:12px"></div>
      </div>
    </div>

    <!-- Submissions -->
    <div class="card">
      <div class="card-title">
        <span>Submissions</span>
        <button class="btn btn-pink btn-sm" id="next-round-btn" onclick="nextRound()" style="padding:6px 14px;font-size:.78rem">‚è≠ Next Round</button>
      </div>
      <div id="host-answer-reveal" style="display:none;margin-bottom:12px">
        <div class="answer-box"><div class="a-label">Musical</div><div class="a-val" id="ans-musical-reveal">‚Äî</div></div>
        <div class="answer-box"><div class="a-label">Song</div><div class="a-val" id="ans-song-reveal">‚Äî</div></div>
      </div>
      <div class="sub-list" id="host-sub-list">
        <div class="muted small" style="padding:8px 0">Waiting for players‚Ä¶</div>
      </div>
    </div>

    <!-- Scoreboard -->
    <div class="card">
      <div class="card-title">üèÜ Scoreboard</div>
      <div class="score-rows" id="host-scoreboard"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 5: PLAYER WAITING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-player-waiting" class="screen" style="justify-content:center;gap:0">
  <div class="spin"></div>
  <div class="logo-alie" style="margin-bottom:4px">‚ú® Alie's</div>
  <div class="logo" style="font-size:1.5rem;margin-bottom:8px">Name That <em>Musical!</em></div>
  <div class="muted small center" style="margin-bottom:6px">You're in the lobby!</div>
  <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--rose3);margin:10px 0" id="player-name-show">Player</div>
  <div class="muted small">Waiting for the host to start‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 6: PLAYER GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-player-game" class="screen pt-banner">
  <div class="logo-alie">‚ú® Alie's</div>
  <div class="logo" style="font-size:1.3rem;margin-bottom:4px">Name That <em>Musical!</em></div>
  <div class="round-pill">Round <span id="player-round-num">1</span> of <span id="player-round-total">10</span></div>
  <div class="player-game-wrap">
    <!-- Lyric cards -->
    <div id="player-lyrics-area" style="display:flex;flex-direction:column;gap:10px"></div>

    <!-- Answer card -->
    <div class="card" id="player-answer-card">
      <div class="card-title">Your Answer</div>
      <div id="player-answer-content">
        <div class="small muted" style="margin-bottom:12px;line-height:1.6">üéØ Lock in early = more points! Points are based on how many lyrics were revealed when you answered.</div>
        <div class="field" style="margin-bottom:10px">
          <label>Musical</label>
          <select id="player-musical-sel" onchange="playerMusicalChange()">
            <option value="">‚Äî Select musical ‚Äî</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:14px">
          <label>Song</label>
          <select id="player-song-sel" onchange="playerSelChange()" disabled>
            <option value="">‚Äî Select song ‚Äî</option>
          </select>
        </div>
        <button class="btn btn-pink btn-full" id="player-lock-btn" onclick="lockAnswer()" disabled>üîí Lock In Answer</button>
      </div>
      <div id="player-locked-display" style="display:none">
        <div class="locked-box">
          <div>‚úÖ Locked in!</div>
          <div class="lbig" id="locked-musical-show">‚Äî</div>
          <div class="lbig" id="locked-song-show">‚Äî</div>
          <div class="lsub">You locked in after <span id="locked-pts-show">‚Äî</span> lyric(s)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 7: PLAYER ROUND RESULT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-player-result" class="screen" style="justify-content:center;gap:0">
  <div class="logo" style="font-size:1.4rem;margin-bottom:26px">Round Result</div>
  <div class="card center" style="max-width:360px">
    <div class="res-circle" id="res-circle">üéµ</div>
    <div class="res-pts" id="res-pts">+0</div>
    <div class="res-total" id="res-total">Total: 0 pts</div>
    <div class="answer-box" style="text-align:left;margin-bottom:10px">
      <div class="a-label">‚úÖ Correct Answer</div>
      <div class="a-val" id="res-correct-musical">‚Äî</div>
      <div class="a-val" id="res-correct-song" style="font-size:.88rem;margin-top:2px">‚Äî</div>
    </div>
    <div class="small muted" id="res-your-answer"></div>
    <div class="sep"></div>
    <div class="small muted">Waiting for next round‚Ä¶ üéÄ</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 8: LYRICS EDITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-lyrics-editor" class="screen pt-banner">
  <div style="width:100%;max-width:600px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <div class="logo" style="font-size:1.3rem">‚úèÔ∏è Lyrics Editor</div>
    <button class="btn btn-outline btn-sm" onclick="go('screen-host-lobby')">‚Üê Lobby</button>
  </div>

  <!-- ADD NEW SONG -->
  <div class="card" style="max-width:600px;width:100%;margin-bottom:12px">
    <div class="card-title" style="cursor:pointer" onclick="toggleAddPanel()">
      <span>‚ûï Add a New Song</span>
      <span class="small muted" id="add-panel-hint">tap to expand</span>
    </div>
    <div id="add-song-panel" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div class="field" style="margin:0">
          <label>Musical</label>
          <input type="text" id="new-musical" placeholder="e.g. Hadestown" list="existing-musicals-list" />
          <datalist id="existing-musicals-list"></datalist>
        </div>
        <div class="field" style="margin:0">
          <label>Song Title</label>
          <input type="text" id="new-song" placeholder="e.g. Wait for Me" />
        </div>
      </div>
      <div id="add-song-error" class="small" style="color:var(--red);display:none;margin-bottom:8px"></div>
      <button class="btn btn-pink btn-sm" onclick="addNewSong()">‚úì Add Song</button>
      <div class="small muted" style="margin-top:8px;line-height:1.5">Adds the song to Firebase ‚Äî visible on all devices.</div>
    </div>
  </div>

  <div class="small muted center" style="max-width:500px;margin-bottom:10px;line-height:1.6">
    Paste the <strong style="color:var(--blush)">full lyrics</strong> for each song. The game randomly picks 4 lines per round.
  </div>
  <input class="editor-filter" id="editor-search" placeholder="üîç Filter by song or musical‚Ä¶" oninput="filterEditor()" />
  <div class="editor-grid" id="editor-grid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 9: GAME ENDED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-ended" class="screen" style="justify-content:center;gap:0">
  <div class="logo-alie" style="margin-bottom:4px">‚ú® Alie's</div>
  <div class="logo" style="margin-bottom:6px">üèÜ Game Over!</div>
  <div class="muted small center">Thanks for playing! üéÄ</div>
  <div class="podium-wrap" id="final-podium"></div>
  <div class="card" style="max-width:360px;width:100%" id="final-full-scores"></div>
  <button class="btn btn-pink mt14" onclick="location.reload()">üîÑ Play Again</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT SONG MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="edit-modal" class="overlay hidden">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Edit Song</div>
    <div class="modal-sub">Fix the musical name or song title.</div>
    <div class="field">
      <label>Musical Name</label>
      <input type="text" id="edit-musical-input" list="existing-musicals-list-edit" />
      <datalist id="existing-musicals-list-edit"></datalist>
    </div>
    <div class="field">
      <label>Song Title</label>
      <input type="text" id="edit-song-input" />
    </div>
    <div id="edit-error" class="small" style="color:var(--red);display:none;margin-bottom:8px"></div>
    <button class="btn btn-pink btn-full" onclick="saveEditSong()">‚úì Save</button>
    <button class="btn btn-outline btn-full mt8" onclick="closeEditModal()">Cancel</button>
    <div class="sep"></div>
    <button class="btn btn-danger btn-full btn-sm" onclick="deleteSong()">üóë Delete Song</button>
    <div class="small muted center mt8">Also deletes saved lyrics.</div>
    <input type="hidden" id="edit-original-key" />
    <input type="hidden" id="edit-original-musical" />
    <input type="hidden" id="edit-original-song" />
    <input type="hidden" id="edit-is-custom" />
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ
const FB_CONFIG = {
  apiKey: "AIzaSyB9j3e0nLqCIfeL-MBuxGGySRH_GqBq2eU",
  authDomain: "namethatmusical-4f26b.firebaseapp.com",
  databaseURL: "https://namethatmusical-4f26b-default-rtdb.firebaseio.com",
  projectId: "namethatmusical-4f26b",
  storageBucket: "namethatmusical-4f26b.firebasestorage.app",
  messagingSenderId: "52948074317",
  appId: "1:52948074317:web:9af6e972fe9e3f05890104",
  measurementId: "G-QZYE4G8LJ7"
};

// ‚îÄ‚îÄ‚îÄ SONG POOL ‚îÄ‚îÄ‚îÄ
let SONG_POOL = [
  {musical:"Hamilton",song:"Alexander Hamilton"},
  {musical:"Hamilton",song:"My Shot"},
  {musical:"Hamilton",song:"The Room Where It Happens"},
  {musical:"Hamilton",song:"You'll Be Back"},
  {musical:"Hamilton",song:"Wait for It"},
  {musical:"Hamilton",song:"Satisfied"},
  {musical:"Hamilton",song:"Burn"},
  {musical:"Hamilton",song:"Helpless"},
  {musical:"Hamilton",song:"Guns and Ships"},
  {musical:"Hamilton",song:"Dear Theodosia"},
  {musical:"Hamilton",song:"Your Obedient Servant"},
  {musical:"Hamilton",song:"Ten Duel Commandments"},
  {musical:"Hamilton",song:"Non-Stop"},
  {musical:"Hamilton",song:"The Schuyler Sisters"},
  {musical:"Hamilton",song:"Say No to This"},
  {musical:"Hamilton",song:"Sincerely, Me"},
  {musical:"Dear Evan Hansen",song:"You Will Be Found"},
  {musical:"Dear Evan Hansen",song:"If I Could Tell Her"},
  {musical:"Dear Evan Hansen",song:"For Forever"},
  {musical:"Dear Evan Hansen",song:"Good For You"},
  {musical:"Dear Evan Hansen",song:"Anybody Have a Map?"},
  {musical:"Be More Chill",song:"Two-Player Game"},
  {musical:"Be More Chill",song:"Michael in the Bathroom"},
  {musical:"Be More Chill",song:"Freeze Your Brain"},
  {musical:"Be More Chill",song:"Loser Geek Whatever"},
  {musical:"Be More Chill",song:"The Pitiful Children"},
  {musical:"Be More Chill",song:"Be More Chill, Pt. 1"},
  {musical:"Be More Chill",song:"The Smartphone Hour (Rich Set a Fire)"},
  {musical:"Heathers: The Musical",song:"Candy Store"},
  {musical:"Heathers: The Musical",song:"Dead Girl Walking"},
  {musical:"Heathers: The Musical",song:"Beautiful"},
  {musical:"Heathers: The Musical",song:"Fight for Me"},
  {musical:"Heathers: The Musical",song:"Meant to Be Yours"},
  {musical:"Heathers: The Musical",song:"My Dead Gay Son"},
  {musical:"Heathers: The Musical",song:"Lifeboat"},
  {musical:"Heathers: The Musical",song:"Big Fun"},
  {musical:"Heathers: The Musical",song:"Our Love Is God"},
  {musical:"Mean Girls",song:"Meet The Plastics"},
  {musical:"Mean Girls",song:"World Burn"},
  {musical:"Mean Girls",song:"Revenge Party"},
  {musical:"Mean Girls",song:"Someone Gets Hurt"},
  {musical:"Mean Girls",song:"Sexy"},
  {musical:"SIX",song:"Ex-Wives"},
  {musical:"SIX",song:"Heart of Stone"},
  {musical:"SIX",song:"All You Wanna Do"},
  {musical:"SIX",song:"Don't Lose Ur Head"},
  {musical:"SIX",song:"Six"},
  {musical:"SIX",song:"I Don't Need Your Love"},
  {musical:"SIX",song:"No Way"},
  {musical:"SIX",song:"Haus of Holbein"},
  {musical:"SIX",song:"Get Down"},
  {musical:"Wicked",song:"Defying Gravity"},
  {musical:"Wicked",song:"Popular"},
  {musical:"Wicked",song:"What Is This Feeling?"},
  {musical:"Wicked",song:"For Good"},
  {musical:"Wicked",song:"No Good Deed"},
  {musical:"Wicked",song:"The Wizard And I"},
  {musical:"Wicked",song:"One Short Day"},
  {musical:"Wicked",song:"Dancing Through Life"},
  {musical:"Wicked",song:"No One Mourns the Wicked"},
  {musical:"Wicked",song:"The Girl in the Bubble"},
  {musical:"Newsies",song:"Carrying The Banner"},
  {musical:"Newsies",song:"Santa Fe"},
  {musical:"Newsies",song:"Seize The Day"},
  {musical:"Newsies",song:"King Of New York"},
  {musical:"Newsies",song:"Watch What Happens"},
  {musical:"Newsies",song:"The World Will Know"},
  {musical:"Newsies",song:"Once And For All"},
  {musical:"Mamma Mia!",song:"Dancing Queen"},
  {musical:"Mamma Mia!",song:"The Winner Takes It All"},
  {musical:"Mamma Mia!",song:"Mamma Mia"},
  {musical:"Mamma Mia!",song:"Super Trouper"},
  {musical:"Mamma Mia!",song:"Gimme! Gimme! Gimme!"},
  {musical:"Mamma Mia!",song:"Slipping Through My Fingers"},
  {musical:"Mamma Mia!",song:"Does Your Mother Know"},
  {musical:"Mamma Mia!",song:"Angel Eyes"},
  {musical:"Mamma Mia!",song:"Honey, Honey"},
  {musical:"Mamma Mia!",song:"Voulez-Vous"},
  {musical:"Frozen",song:"For the First Time in Forever"},
  {musical:"Frozen",song:"Love Is an Open Door"},
  {musical:"Frozen",song:"Do You Want to Build a Snowman?"},
  {musical:"Frozen",song:"In Summer"},
  {musical:"Frozen",song:"Monster"},
  {musical:"Frozen",song:"Dangerous to Dream"},
  {musical:"Frozen",song:"Fixer Upper"},
  {musical:"Grease",song:"You're The One That I Want"},
  {musical:"Grease",song:"Summer Nights"},
  {musical:"Grease",song:"Hopelessly Devoted To You"},
  {musical:"Grease",song:"Beauty School Dropout"},
  {musical:"Beauty and the Beast",song:"Belle"},
  {musical:"Beauty and the Beast",song:"Be Our Guest"},
  {musical:"Beauty and the Beast",song:"Gaston"},
  {musical:"Beauty and the Beast",song:"Evermore"},
  {musical:"Beauty and the Beast",song:"Days In The Sun"},
  {musical:"Little Shop of Horrors",song:"Skid Row (Downtown)"},
  {musical:"Little Shop of Horrors",song:"Feed Me (Git It!)"},
  {musical:"Little Shop of Horrors",song:"Suddenly, Seymour"},
  {musical:"Les Mis√©rables",song:"I Dreamed A Dream"},
  {musical:"Les Mis√©rables",song:"Do You Hear The People Sing?"},
  {musical:"Les Mis√©rables",song:"One Day More"},
  {musical:"The Greatest Showman",song:"This Is Me"},
  {musical:"The Greatest Showman",song:"A Million Dreams"},
  {musical:"The Greatest Showman",song:"Never Enough"},
  {musical:"The Greatest Showman",song:"The Other Side"},
  {musical:"The Greatest Showman",song:"Tightrope"},
  {musical:"Chicago",song:"Cell Block Tango"},
  {musical:"Chicago",song:"We Both Reached For The Gun"},
  {musical:"SpongeBob SquarePants: The Musical",song:"Best Day Ever"},
  {musical:"SpongeBob SquarePants: The Musical",song:"Hero is My Middle Name"},
  {musical:"SpongeBob SquarePants: The Musical",song:"Bikini Bottom Day"},
  {musical:"SpongeBob SquarePants: The Musical",song:"[Just a] Simple Sponge"},
  {musical:"Avenue Q",song:"If You Were Gay"},
  {musical:"Avenue Q",song:"What Do You Do with a B.A. in English / It Sucks to Be Me"},
  {musical:"Into the Woods",song:"Agony"},
  {musical:"Into the Woods",song:"Last Midnight"},
  {musical:"Into the Woods",song:"Your Fault"},
  {musical:"Into the Woods",song:"On the Steps of the Palace"},
  {musical:"The Little Mermaid",song:"Part of Your World"},
  {musical:"Waitress",song:"When He Sees Me"},
  {musical:"Waitress",song:"Opening Up"},
  {musical:"Hadestown",song:"Wait for Me"},
  {musical:"Hadestown",song:"Why We Build the Wall"},
  {musical:"The Phantom of the Opera",song:"The Music Of The Night"},
  {musical:"The Phantom of the Opera",song:"The Phantom Of The Opera"},
  {musical:"Rent",song:"Seasons of Love"},
  {musical:"Rent",song:"Blackout"},
  {musical:"tick, tick‚Ä¶ BOOM!",song:"30/90"},
  {musical:"tick, tick‚Ä¶ BOOM!",song:"Louder Than Words"},
  {musical:"tick, tick‚Ä¶ BOOM!",song:"Therapy"},
  {musical:"Anastasia",song:"Once Upon a December"},
  {musical:"Matilda the Musical",song:"Revolting Children"},
  {musical:"Hairspray",song:"Good Morning Baltimore"},
  {musical:"Hairspray",song:"Mama, I'm a Big Girl Now"},
  {musical:"Shucked",song:"Corn"},
  {musical:"Shucked",song:"Independently Owned"},
  {musical:"Shucked",song:"We Love Jesus"},
  {musical:"Shucked",song:"Best Man Wins"},
  {musical:"EPIC: The Musical",song:"Warrior of the Mind"},
  {musical:"EPIC: The Musical",song:"Get in the Water"},
  {musical:"EPIC: The Musical",song:"Would You Fall in Love with Me Again"},
  {musical:"The Guy Who Didn't Like Musicals",song:"The Guy Who Didn't Like Musicals"},
  {musical:"The Guy Who Didn't Like Musicals",song:"Join Us (And Die)"},
  {musical:"The Guy Who Didn't Like Musicals",song:"Show Stoppin Number"},
  {musical:"The Guy Who Didn't Like Musicals",song:"America Is Great Again"},
  {musical:"Beetlejuice",song:"Dead Mom"},
  {musical:"Beetlejuice",song:"That Beautiful Sound"},
  {musical:"Beetlejuice",song:"Say My Name"},
  {musical:"Annie",song:"It's The Hard-Knock Life"},
  {musical:"Annie",song:"Tomorrow"},
  {musical:"The Book of Mormon",song:"You and Me (But Mostly Me)"},
  {musical:"The Book of Mormon",song:"The Acceptance Song"},
  {musical:"The Sound of Music",song:"Do-Re-Mi"},
  {musical:"The Sound of Music",song:"My Favorite Things"},
  {musical:"Fiddler on the Roof",song:"If I Were a Rich Man"},
  {musical:"Anything Goes",song:"Anything Goes"},
  {musical:"Anything Goes",song:"Gimme Gimme"},
  {musical:"La La Land",song:"Another Day Of Sun"},
  {musical:"La La Land",song:"A Lovely Night"},
  {musical:"Legally Blonde",song:"Omigod You Guys"},
  {musical:"Moulin Rouge!",song:"Lady Marmalade"},
  {musical:"Something Rotten!",song:"Hard to Be the Bard"},
  {musical:"Something Rotten!",song:"A Musical"},
  {musical:"Something Rotten!",song:"God, I Hate Shakespeare"},
  {musical:"Spring Awakening",song:"Mama Who Bore Me"},
  {musical:"Hercules",song:"Zero To Hero"},
  {musical:"Hercules",song:"I Won't Say (I'm In Love)"},
  {musical:"Spies Are Forever",song:"Spies Are Forever"},
  {musical:"Spies Are Forever",song:"No One Remembers Achmed"},
  {musical:"Nerdy Prudes Must Die",song:"Nerdy Prudes Must Die"},
  {musical:"Nerdy Prudes Must Die",song:"Hatchet Town"},
];

function getMusicals() { return [...new Set(SONG_POOL.map(s => s.musical))].sort(); }
function getSongs(m) { return SONG_POOL.filter(s => s.musical === m); }
function songKey(musical, song) {
  return (musical + '___' + song).replace(/[^a-zA-Z0-9_]/g, '_');
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let db, gameRef, playersRef, roundRef, subsRef, lyricsRef, customSongsRef, correctionsRef;
let gameCode='', playerId='', playerName='', isHost=false;
let currentRound=0, totalRounds=10;
let revealedCount=0;
let currentSong=null;
let locked=false;
let lockedAtReveal=0; // how many lyrics were revealed when player locked in
let allLyrics={};
let players={};
let lastRoundNum=-1;
let usedSongKeys=new Set(); // track used songs per game

// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ
function initFirebase() {
  showBanner('connecting','‚ü≥ Connecting‚Ä¶');
  try {
    if (!firebase.apps.length) firebase.initializeApp(FB_CONFIG);
    db = firebase.database();
    db.ref('.info/connected').on('value', snap => {
      if (snap.val()===true) { showBanner('connected','‚úì Connected'); setTimeout(()=>hideBanner(),2200); }
      else showBanner('error','‚úó Disconnected');
    });
    lyricsRef = db.ref('lyrics');
    lyricsRef.on('value', snap => { allLyrics = snap.val()||{}; });
    correctionsRef = db.ref('corrections');
    correctionsRef.on('value', snap => {
      const corr = snap.val()||{};
      Object.values(corr).forEach(c => {
        const idx = SONG_POOL.findIndex(p => p.musical===c.origMusical && p.song===c.origSong);
        if (idx!==-1) { SONG_POOL[idx].musical=c.newMusical; SONG_POOL[idx].song=c.newSong; SONG_POOL[idx]._correctionKey=c.correctionKey; }
      });
    });
    customSongsRef = db.ref('customSongs');
    customSongsRef.on('value', snap => {
      const custom = snap.val()||{};
      for (let i=SONG_POOL.length-1; i>=0; i--) { if (SONG_POOL[i].custom) SONG_POOL.splice(i,1); }
      Object.entries(custom).forEach(([fbKey,s]) => {
        if (s && s.musical && s.song && !SONG_POOL.find(p=>p.musical===s.musical&&p.song===s.song))
          SONG_POOL.push({musical:s.musical,song:s.song,custom:true,fbKey});
      });
      if (document.getElementById('screen-lyrics-editor').classList.contains('active')) filterEditor();
    });
  } catch(e) { showBanner('error','‚úó Error: '+e.message); }
}

function showBanner(type,msg) {
  const b=document.getElementById('fb-banner');
  b.className=type;
  b.querySelector('.fb-dot').className='fb-dot'+(type==='connecting'?' pulse':'');
  document.getElementById('fb-banner-text').textContent=msg;
}
function hideBanner() { document.getElementById('fb-banner').classList.add('hidden'); }

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ
function go(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ‚îÄ‚îÄ‚îÄ HOST LOBBY ‚îÄ‚îÄ‚îÄ
function startHostLobby() {
  isHost=true;
  gameCode=Math.random().toString(36).substring(2,7).toUpperCase();
  gameRef    = db.ref('games/'+gameCode);
  playersRef = db.ref('games/'+gameCode+'/players');
  roundRef   = db.ref('games/'+gameCode+'/round');
  subsRef    = db.ref('games/'+gameCode+'/submissions');

  gameRef.set({status:'lobby',round:{number:1,total:totalRounds,revealed:0,ready:false,answerShown:false}});

  document.getElementById('lobby-code').textContent=gameCode;
  document.getElementById('qrcode').innerHTML='';
  const joinUrl=location.href.split('?')[0]+'?code='+gameCode;
  document.getElementById('join-url-text').textContent=joinUrl;
  new QRCode(document.getElementById('qrcode'),{text:joinUrl,width:140,height:140,colorDark:'#1a0a14',colorLight:'#ffffff'});

  usedSongKeys.clear();
  playersRef.on('value',snap=>{players=snap.val()||{};renderLobbyPlayers();renderHostScoreboard();});
  subsRef.on('value',snap=>renderSubs(snap.val()));
  go('screen-host-lobby');
  buildLyricsEditor();
}

function renderLobbyPlayers() {
  const list=document.getElementById('lobby-player-list');
  const arr=Object.values(players);
  document.getElementById('lobby-count').textContent=arr.length+' joined';
  if (!arr.length) {list.innerHTML='<div class="no-players">Share the code ‚Äî players will appear here!</div>';return;}
  list.innerHTML=arr.map(p=>`
    <div class="chip">
      <div class="chip-av">${esc(p.name)[0].toUpperCase()}</div>
      <div class="chip-name">${esc(p.name)}</div>
      <div class="chip-score">${p.score||0} pts</div>
    </div>`).join('');
}

function copyLink() {
  navigator.clipboard.writeText(document.getElementById('join-url-text').textContent)
    .then(()=>alert('Link copied! üéÄ'));
}

// ‚îÄ‚îÄ‚îÄ HOST: START GAME ‚îÄ‚îÄ‚îÄ
function startGame() {
  if (!Object.keys(players).length) {alert('Wait for at least one player!');return;}
  gameRef.update({status:'playing'});
  currentRound=1;
  document.getElementById('host-round-num').textContent=1;
  document.getElementById('host-round-total').textContent=totalRounds;
  go('screen-host-game');
  pushRoundState({number:1,total:totalRounds,revealed:0,ready:false,answerShown:false});
  loadRandomSong();
}

// ‚îÄ‚îÄ‚îÄ HOST: RANDOM SONG AUTO LOAD ‚îÄ‚îÄ‚îÄ
function loadRandomSong() {
  document.getElementById('song-loading').style.display='block';
  document.getElementById('song-loaded').style.display='none';

  // Find songs with lyrics (at least 4 usable lines) that haven't been used yet
  const eligible = SONG_POOL.filter(s => {
    const key = songKey(s.musical, s.song);
    if (usedSongKeys.has(key)) return false;
    const stored = allLyrics[key];
    return stored && stored.lines && stored.lines.length >= 4;
  });

  if (!eligible.length) {
    // Reset used songs and try again if all songs have been used
    usedSongKeys.clear();
    const retryEligible = SONG_POOL.filter(s => {
      const key = songKey(s.musical, s.song);
      const stored = allLyrics[key];
      return stored && stored.lines && stored.lines.length >= 4;
    });
    if (!retryEligible.length) {
      // No songs have lyrics at all ‚Äî fall back to waiting
      document.getElementById('song-loading').innerHTML = `
        <div style="color:var(--red);text-align:center">
          <div style="font-size:1.5rem;margin-bottom:8px">‚ö†Ô∏è</div>
          <div class="small">No songs have lyrics yet!<br>Go to the Lyrics Editor to add some.</div>
          <button class="btn btn-outline btn-sm mt8" onclick="go('screen-lyrics-editor')">‚úèÔ∏è Add Lyrics</button>
        </div>`;
      return;
    }
    loadRandomFrom(retryEligible);
    return;
  }

  // Small delay for suspense ‚ú®
  setTimeout(() => loadRandomFrom(eligible), 600);
}

function loadRandomFrom(eligible) {
  const pick = eligible[Math.floor(Math.random() * eligible.length)];
  const key = songKey(pick.musical, pick.song);
  usedSongKeys.add(key);

  const lines = allLyrics[key].lines;
  // Randomly pick 4 distinct lines
  const pool = [...lines];
  const chosen = [];
  while (chosen.length < 4 && pool.length > 0) {
    const idx = Math.floor(Math.random() * pool.length);
    chosen.push(pool.splice(idx,1)[0]);
  }

  currentSong = {musical:pick.musical, song:pick.song, lyrics:chosen};
  revealedCount = 0;

  subsRef.remove();
  document.getElementById('song-loading').style.display='none';
  document.getElementById('song-loaded').style.display='block';
  document.getElementById('loaded-song-title').textContent='üé≤ Hidden until answer!';
  document.getElementById('loaded-song-musical').textContent='Reveal when ready';
  document.getElementById('host-answer-reveal').style.display='none';
  document.getElementById('host-sub-list').innerHTML='<div class="muted small" style="padding:8px 0">Waiting for players to lock in‚Ä¶</div>';

  // Reset progress pips
  for(let i=0;i<4;i++) {
    const pip=document.getElementById('pip-'+i);
    if(pip) pip.classList.remove('active');
  }

  renderHostLyrics();
  pushRoundState({number:currentRound,total:totalRounds,revealed:0,ready:true,answerShown:false,musical:currentSong.musical,song:currentSong.song,lyrics:chosen});
}

function renderHostLyrics() {
  const pts=[5,4,3,2];
  document.getElementById('host-lyrics-area').innerHTML=currentSong.lyrics.map((l,i)=>`
    <div class="lyric-reveal-card ${i<revealedCount?'revealed':'locked-card'}" id="hlc-${i}">
      <div class="lyric-num-row">Lyric ${i+1} <span class="pt-chip">${pts[i]} pts</span> ${i<revealedCount?'‚úÖ':'üîí'}</div>
      ${i<revealedCount
        ? `<div class="lyric-body">${esc(l)}</div>`
        : `<div class="lyric-hidden">Not yet revealed</div>`}
    </div>`).join('');
  document.getElementById('reveal-next-btn').disabled=revealedCount>=4;
}

function revealNext() {
  if (revealedCount>=4) return;
  revealedCount++;
  // Update progress pips
  for(let i=0;i<revealedCount;i++) {
    const pip=document.getElementById('pip-'+i);
    if(pip) pip.classList.add('active');
  }
  renderHostLyrics();
  pushRoundState({number:currentRound,total:totalRounds,revealed:revealedCount,ready:true,answerShown:false,musical:currentSong.musical,song:currentSong.song,lyrics:currentSong.lyrics});
}

function showAnswer() {
  if (!currentSong) return;
  document.getElementById('host-answer-reveal').style.display='block';
  document.getElementById('ans-musical-reveal').textContent=currentSong.musical;
  document.getElementById('ans-song-reveal').textContent=currentSong.song;
  document.getElementById('loaded-song-title').textContent=currentSong.song;
  document.getElementById('loaded-song-musical').textContent=currentSong.musical;
  pushRoundState({number:currentRound,total:totalRounds,revealed:revealedCount,ready:true,answerShown:true,musical:currentSong.musical,song:currentSong.song,lyrics:currentSong.lyrics});
  scoreRound();
}

function scoreRound() {
  subsRef.once('value',snap=>{
    const subs=snap.val()||{};
    Object.entries(subs).forEach(([pid,sub])=>{
      if (sub.scored) return;
      const correct=sub.musical===currentSong.musical && sub.song===currentSong.song;
      // Points based on how many lyrics were revealed when they locked in
      const pts = correct ? (sub.pts||1) : 0;
      if (correct) playersRef.child(pid+'/score').transaction(v=>(v||0)+pts);
      subsRef.child(pid).update({correct,scored:true});
    });
  });
}

function nextRound() {
  if (currentRound>=totalRounds) {endGame();return;}
  currentRound++;
  currentSong=null; revealedCount=0;
  document.getElementById('host-round-num').textContent=currentRound;
  document.getElementById('host-answer-reveal').style.display='none';
  subsRef.remove();
  document.getElementById('host-sub-list').innerHTML='<div class="muted small" style="padding:8px 0">Waiting for players‚Ä¶</div>';
  document.getElementById('host-lyrics-area').innerHTML='';
  pushRoundState({number:currentRound,total:totalRounds,revealed:0,ready:false,answerShown:false});
  loadRandomSong();
}

function renderSubs(subs) {
  const list=document.getElementById('host-sub-list');
  if (!subs||!Object.keys(subs).length) {
    list.innerHTML='<div class="muted small" style="padding:8px 0">Waiting for players to lock in‚Ä¶</div>';return;
  }
  list.innerHTML=Object.entries(subs).map(([pid,sub])=>{
    const p=players[pid]||{name:'?'};
    const cls=sub.scored?(sub.correct?'correct':'wrong'):'pending';
    const ptsLabel=sub.scored?(sub.correct?`+${sub.pts}`:'0'):`${sub.pts}pt`;
    return `<div class="sub-item ${cls}">
      <div class="sub-name">${esc(p.name)}</div>
      <div class="sub-guess">${esc(sub.musical||'')} / ${esc(sub.song||'‚Ä¶')}</div>
      <div class="sub-pts">${ptsLabel}</div>
    </div>`;
  }).join('');
  renderHostScoreboard();
}

function renderHostScoreboard() {
  const sorted=Object.entries(players).sort(([,a],[,b])=>(b.score||0)-(a.score||0));
  document.getElementById('host-scoreboard').innerHTML=sorted.map(([,p],i)=>`
    <div class="score-row">
      <div class="score-rank">${i+1}</div>
      <div class="chip-av" style="width:26px;height:26px;font-size:.7rem">${esc(p.name)[0].toUpperCase()}</div>
      <div style="flex:1;font-size:.85rem">${esc(p.name)}</div>
      <div class="score-pts">${p.score||0}</div>
    </div>`).join('');
}

function pushRoundState(state) { roundRef.set(state); }

// ‚îÄ‚îÄ‚îÄ END GAME ‚îÄ‚îÄ‚îÄ
function endGame() {
  gameRef.update({status:'ended'});
  const sorted=Object.values(players).sort((a,b)=>(b.score||0)-(a.score||0));
  const podiumOrder=[sorted[1],sorted[0],sorted[2]].filter(Boolean);
  const cls=['p2','p1','p3'], medals=['ü•à','ü•á','ü•â'];
  document.getElementById('final-podium').innerHTML=podiumOrder.map((p,i)=>`
    <div class="podium-col ${cls[i]}">
      <div class="p-medal">${medals[i]}</div>
      <div class="p-name">${esc(p.name)}</div>
      <div class="p-pts">${p.score||0} pts</div>
    </div>`).join('');
  document.getElementById('final-full-scores').innerHTML=`
    <div class="card-title">Final Scores</div>
    ${sorted.map((p,i)=>`<div class="score-row"><div class="score-rank">${i+1}</div><div style="flex:1">${esc(p.name)}</div><div class="score-pts">${p.score||0}</div></div>`).join('')}`;
  go('screen-ended');
}

// ‚îÄ‚îÄ‚îÄ PLAYER JOIN ‚îÄ‚îÄ‚îÄ
function joinGame() {
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  const name=document.getElementById('join-name').value.trim();
  if (!code||!name) {showJoinErr('Please fill in both fields.');return;}
  db.ref('games/'+code).once('value').then(snap=>{
    if (!snap.exists()) {showJoinErr('Game not found. Check the code!');return;}
    gameCode=code; playerName=name;
    playerId='p_'+Math.random().toString(36).substring(2,10);
    gameRef    = db.ref('games/'+gameCode);
    playersRef = db.ref('games/'+gameCode+'/players');
    roundRef   = db.ref('games/'+gameCode+'/round');
    subsRef    = db.ref('games/'+gameCode+'/submissions');
    playersRef.child(playerId).set({name,score:0,joined:Date.now()});
    document.getElementById('player-name-show').textContent=name;
    // Populate musical dropdown
    const ms=document.getElementById('player-musical-sel');
    ms.innerHTML='<option value="">‚Äî Select musical ‚Äî</option>';
    getMusicals().forEach(m=>{const o=document.createElement('option');o.value=o.textContent=m;ms.appendChild(o);});
    go('screen-player-waiting');
    listenAsPlayer();
  }).catch(e=>showJoinErr('Error: '+e.message));
}

function showJoinErr(msg) {
  const el=document.getElementById('join-error');
  el.textContent=msg; el.style.display='block';
}

// ‚îÄ‚îÄ‚îÄ PLAYER: LISTEN TO GAME STATE ‚îÄ‚îÄ‚îÄ
function listenAsPlayer() {
  gameRef.child('status').on('value',snap=>{
    if (snap.val()==='ended') showPlayerEndScreen();
  });

  roundRef.on('value',snap=>{
    const r=snap.val();
    if (!r) return;
    document.getElementById('player-round-num').textContent=r.number;
    document.getElementById('player-round-total').textContent=r.total;

    if (r.number!==lastRoundNum) {
      lastRoundNum=r.number;
      locked=false; lockedAtReveal=0;
      resetPlayerAnswerUI();
      currentRound=r.number;
      initPlayerLyricCards();
    }

    updatePlayerLyrics(r.revealed||0, r.lyrics||[]);

    if (r.answerShown && r.ready) {
      setTimeout(()=>showPlayerResult(r),1400);
    } else if (r.ready) {
      const cur=document.querySelector('.screen.active');
      if (!cur||cur.id!=='screen-player-game') go('screen-player-game');
    } else {
      const cur=document.querySelector('.screen.active');
      if (!cur||(cur.id!=='screen-player-waiting'&&cur.id!=='screen-player-game')) go('screen-player-waiting');
    }
  });
}

function initPlayerLyricCards() {
  const area=document.getElementById('player-lyrics-area');
  area.innerHTML='';
  const pts=[5,4,3,2];
  for (let i=0;i<4;i++) {
    area.innerHTML+=`
      <div class="lyric-player-card" id="plc-${i}">
        <div class="lyric-num-row">Lyric ${i+1} <span class="pt-chip">${pts[i]} pts</span></div>
        <div class="lyric-hidden" id="plc-text-${i}">Not yet revealed‚Ä¶</div>
      </div>`;
  }
}

function updatePlayerLyrics(revealed, lyrics) {
  for (let i=0;i<4;i++) {
    const card=document.getElementById('plc-'+i);
    const text=document.getElementById('plc-text-'+i);
    if (!card) return;
    if (i<revealed && lyrics[i]) {
      card.classList.add('revealed');
      text.className='lyric-body';
      text.textContent=lyrics[i];
    } else {
      card.classList.remove('revealed');
      text.className='lyric-hidden';
      text.textContent='Not yet revealed‚Ä¶';
    }
  }
}

// ‚îÄ‚îÄ‚îÄ PLAYER ANSWER ‚îÄ‚îÄ‚îÄ
function resetPlayerAnswerUI() {
  document.getElementById('player-answer-content').style.display='block';
  document.getElementById('player-locked-display').style.display='none';
  document.getElementById('player-musical-sel').value='';
  document.getElementById('player-song-sel').innerHTML='<option value="">‚Äî Select song ‚Äî</option>';
  document.getElementById('player-song-sel').disabled=true;
  document.getElementById('player-lock-btn').disabled=true;
}

function playerMusicalChange() {
  const m=document.getElementById('player-musical-sel').value;
  const ss=document.getElementById('player-song-sel');
  ss.innerHTML='<option value="">‚Äî Select song ‚Äî</option>';
  ss.disabled=!m;
  if (m) getSongs(m).forEach(s=>{const o=document.createElement('option');o.value=o.textContent=s.song;ss.appendChild(o);});
  checkLockReady();
}
function playerSelChange() { checkLockReady(); }
function checkLockReady() {
  const m=document.getElementById('player-musical-sel').value;
  const s=document.getElementById('player-song-sel').value;
  document.getElementById('player-lock-btn').disabled=!(m&&s&&!locked);
}

function lockAnswer() {
  if (locked) return;
  const musical=document.getElementById('player-musical-sel').value;
  const song=document.getElementById('player-song-sel').value;
  if (!musical||!song) return;
  locked=true;

  // AUTO-detect points: based on current revealed count at lock-in time
  // We read the current round state to know how many lyrics have been revealed
  roundRef.once('value', snap => {
    const r = snap.val()||{};
    const revealedNow = r.revealed || 0;
    // Points: 5 if 1 lyric shown, 4 if 2, 3 if 3, 2 if 4 (or more)
    const ptsMap = {1:5, 2:4, 3:3, 4:2};
    const pts = ptsMap[revealedNow] || 2;
    lockedAtReveal = revealedNow;

    subsRef.child(playerId).set({musical,song,pts,locked:true,scored:false,correct:false,revealedAt:revealedNow,ts:Date.now()});
    document.getElementById('player-answer-content').style.display='none';
    document.getElementById('player-locked-display').style.display='block';
    document.getElementById('locked-musical-show').textContent=musical;
    document.getElementById('locked-song-show').textContent=song;
    document.getElementById('locked-pts-show').textContent=revealedNow;
  });
}

// ‚îÄ‚îÄ‚îÄ PLAYER: ROUND RESULT ‚îÄ‚îÄ‚îÄ
async function showPlayerResult(r) {
  const cur=document.querySelector('.screen.active');
  if (cur&&cur.id==='screen-player-result') return;

  const [subSnap,scoreSnap]=await Promise.all([
    subsRef.child(playerId).once('value'),
    playersRef.child(playerId+'/score').once('value')
  ]);
  const sub=subSnap.val();
  const totalScore=scoreSnap.val()||0;

  document.getElementById('res-correct-musical').textContent=r.musical||'‚Äî';
  document.getElementById('res-correct-song').textContent=r.song||'‚Äî';
  document.getElementById('res-total').textContent='Your total: '+totalScore+' pts';

  const circle=document.getElementById('res-circle');
  const ptsEl=document.getElementById('res-pts');
  if (!sub||!sub.locked) {
    circle.className='res-circle res-noans'; circle.textContent='üò∂';
    ptsEl.textContent='+0'; document.getElementById('res-your-answer').textContent='You didn\'t lock in this round.';
  } else if (sub.correct) {
    circle.className='res-circle res-correct'; circle.textContent='üéâ';
    ptsEl.textContent='+'+sub.pts;
    document.getElementById('res-your-answer').textContent='Your answer: '+sub.musical+' / '+sub.song+(sub.revealedAt?' (locked in after lyric '+sub.revealedAt+')':'');
  } else {
    circle.className='res-circle res-wrong'; circle.textContent='üò¨';
    ptsEl.textContent='+0'; document.getElementById('res-your-answer').textContent='Your answer: '+(sub.musical||'?')+' / '+(sub.song||'?');
  }
  go('screen-player-result');
}

async function showPlayerEndScreen() {
  const scoreSnap=await playersRef.child(playerId+'/score').once('value');
  const finalScore=scoreSnap.val()||0;
  document.getElementById('final-podium').innerHTML=`<div class="podium-col p1"><div class="p-medal">üéÄ</div><div class="p-name">${esc(playerName)}</div><div class="p-pts">${finalScore} pts</div></div>`;
  document.getElementById('final-full-scores').innerHTML=`<div class="card-title">Your Final Score</div><div style="text-align:center;font-family:'Playfair Display',serif;font-size:3rem;color:var(--rose2);padding:16px">${finalScore}</div><div class="muted small center">points üéÄ</div>`;
  go('screen-ended');
}

// ‚îÄ‚îÄ‚îÄ LYRICS EDITOR ‚îÄ‚îÄ‚îÄ
function buildLyricsEditor() {
  const grid=document.getElementById('editor-grid');
  if (!grid._editListenerAttached) {
    grid._editListenerAttached=true;
    grid.addEventListener('click',e=>{
      const btn=e.target.closest('.edit-song-btn');
      if (!btn) return;
      e.stopPropagation();
      openEditModal(btn.dataset.key,btn.dataset.musical,btn.dataset.song);
    });
  }
  renderEditorGrid(SONG_POOL);
}

function filterEditor() {
  const q=document.getElementById('editor-search').value.toLowerCase();
  renderEditorGrid(SONG_POOL.filter(s=>s.musical.toLowerCase().includes(q)||s.song.toLowerCase().includes(q)));
}

function renderEditorGrid(songs) {
  const grid=document.getElementById('editor-grid');
  if (!songs.length) {grid.innerHTML='<div class="muted center small" style="padding:24px">No songs match.</div>';return;}
  grid.innerHTML='';
  songs.forEach(s=>{
    const key=songKey(s.musical,s.song);
    const stored=allLyrics[key]||{};
    const lines=stored.lines||[];
    const hasLyrics=lines.length>=4;
    const textVal=lines.join('\n').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const statusClass=hasLyrics?'has-lyrics':'no-lyrics';
    const statusText=hasLyrics?('‚úì '+lines.length+' lines'):'‚úó No lyrics';

    const row=document.createElement('div');
    row.className='song-row'; row.id='erow-'+key;
    row.innerHTML=
      '<div class="song-row-header" id="ehdr-'+key+'">' +
        '<div class="song-row-info">' +
          '<div class="song-row-title">'+esc(s.song)+'</div>' +
          '<div class="song-row-musical">'+esc(s.musical)+'</div>' +
        '</div>' +
        '<span class="song-row-status '+statusClass+'" id="badge-'+key+'">'+statusText+'</span>' +
        '<button class="edit-song-btn btn btn-ghost btn-sm" style="font-size:.9rem;padding:4px 8px" title="Edit" data-key="'+key+'" data-musical="'+esc(s.musical)+'" data-song="'+esc(s.song)+'">‚úèÔ∏è</button>' +
      '</div>' +
      '<div class="song-row-body" id="ebody-'+key+'">' +
        '<p class="muted small" style="margin-bottom:10px;line-height:1.5">Paste full lyrics ‚Äî one line per row. Lines under 15 characters are skipped.</p>' +
        '<textarea id="eta-'+key+'" placeholder="Paste full lyrics here‚Ä¶" style="width:100%;min-height:200px;padding:11px 13px;background:var(--bg);border:1px solid var(--border);border-radius:var(--r);color:var(--blush);font-family:\'DM Sans\',sans-serif;font-size:.83rem;line-height:1.65;outline:none;resize:vertical">'+textVal+'</textarea>' +
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px">' +
          '<div class="small muted" id="linecount-'+key+'">'+(lines.length?lines.length+' usable lines':'Nothing saved yet')+'</div>' +
          '<div class="small muted">Saves automatically</div>' +
        '</div>' +
      '</div>';

    row.querySelector('.song-row-header').addEventListener('click',()=>toggleEditorRow(key));
    const ta=row.querySelector('textarea');
    ta.addEventListener('focus',()=>ta.style.borderColor='var(--rose)');
    ta.addEventListener('blur',()=>ta.style.borderColor='var(--border)');
    ta.addEventListener('input',()=>saveLyricBlob(key,ta.value));
    grid.appendChild(row);
  });
}

function toggleEditorRow(key) {
  document.getElementById('ebody-'+key).classList.toggle('open');
  document.getElementById('ehdr-'+key).classList.toggle('open');
}

let saveTimers={};
function saveLyricBlob(key,rawText) {
  clearTimeout(saveTimers[key]);
  saveTimers[key]=setTimeout(()=>{
    const lines=rawText.split('\n').map(l=>l.trim()).filter(l=>l.length>=15);
    lyricsRef.child(key).update({lines}).then(()=>{
      allLyrics[key]=allLyrics[key]||{};
      allLyrics[key].lines=lines;
      const hasLyrics=lines.length>=4;
      const badge=document.getElementById('badge-'+key);
      const counter=document.getElementById('linecount-'+key);
      if(badge){badge.className='song-row-status '+(hasLyrics?'has-lyrics':'no-lyrics');badge.textContent=hasLyrics?('‚úì '+lines.length+' lines'):'‚úó No lyrics';}
      if(counter) counter.textContent=lines.length+' usable lines stored';
    });
  },700);
}

// ‚îÄ‚îÄ‚îÄ ADD NEW SONG ‚îÄ‚îÄ‚îÄ
function toggleAddPanel() {
  const panel=document.getElementById('add-song-panel');
  const hint=document.getElementById('add-panel-hint');
  const open=panel.style.display!=='none';
  panel.style.display=open?'none':'block';
  hint.textContent=open?'tap to expand':'tap to collapse';
  if (!open) {
    const dl=document.getElementById('existing-musicals-list');
    dl.innerHTML='';
    getMusicals().forEach(m=>{const o=document.createElement('option');o.value=m;dl.appendChild(o);});
  }
}

function addNewSong() {
  const musical=document.getElementById('new-musical').value.trim();
  const song=document.getElementById('new-song').value.trim();
  const errEl=document.getElementById('add-song-error');
  errEl.style.display='none';
  if (!musical||!song) {errEl.textContent='Please fill in both fields.';errEl.style.display='block';return;}
  if (SONG_POOL.find(p=>p.musical===musical&&p.song===song)) {errEl.textContent='That song already exists!';errEl.style.display='block';return;}
  const pushRef=customSongsRef.push();
  pushRef.set({musical,song}).then(()=>{
    SONG_POOL.push({musical,song,custom:true,fbKey:pushRef.key});
    document.getElementById('new-musical').value='';
    document.getElementById('new-song').value='';
    document.getElementById('add-song-panel').style.display='none';
    document.getElementById('add-panel-hint').textContent='tap to expand';
    filterEditor();
    setTimeout(()=>{
      const key=songKey(musical,song);
      const row=document.getElementById('erow-'+key);
      if(row){row.style.outline='2px solid var(--rose)';setTimeout(()=>row.style.outline='',2000);}
    },100);
  }).catch(e=>{errEl.textContent='Firebase error: '+e.message;errEl.style.display='block';});
}

// ‚îÄ‚îÄ‚îÄ EDIT/DELETE SONG ‚îÄ‚îÄ‚îÄ
let editingKey='';
function openEditModal(key,musical,song) {
  editingKey=key;
  document.getElementById('edit-musical-input').value=musical;
  document.getElementById('edit-song-input').value=song;
  document.getElementById('edit-original-key').value=key;
  document.getElementById('edit-original-musical').value=musical;
  document.getElementById('edit-original-song').value=song;
  document.getElementById('edit-error').style.display='none';
  const entry=SONG_POOL.find(p=>songKey(p.musical,p.song)===key);
  document.getElementById('edit-is-custom').value=entry&&entry.custom?entry.fbKey||'':'';
  const dl=document.getElementById('existing-musicals-list-edit');
  dl.innerHTML='';
  getMusicals().forEach(m=>{const o=document.createElement('option');o.value=m;dl.appendChild(o);});
  document.getElementById('edit-modal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('edit-modal').classList.add('hidden');
  editingKey='';
}

function saveEditSong() {
  const newMusical=document.getElementById('edit-musical-input').value.trim();
  const newSong=document.getElementById('edit-song-input').value.trim();
  const origMusical=document.getElementById('edit-original-musical').value;
  const origSong=document.getElementById('edit-original-song').value;
  const origKey=document.getElementById('edit-original-key').value;
  const fbKey=document.getElementById('edit-is-custom').value;
  const errEl=document.getElementById('edit-error');
  errEl.style.display='none';
  if (!newMusical||!newSong) {errEl.textContent='Both fields are required.';errEl.style.display='block';return;}
  if (newMusical===origMusical&&newSong===origSong) {closeEditModal();return;}
  if (SONG_POOL.find(p=>p.musical===newMusical&&p.song===newSong&&songKey(p.musical,p.song)!==origKey)) {
    errEl.textContent='A song with that name already exists.';errEl.style.display='block';return;
  }
  const newKey=songKey(newMusical,newSong);
  const doUpdate=()=>{
    if (newKey!==origKey) {
      lyricsRef.child(origKey).once('value').then(snap=>{
        const data=snap.val();
        if(data){lyricsRef.child(newKey).set(data);lyricsRef.child(origKey).remove();allLyrics[newKey]=data;delete allLyrics[origKey];}
      });
    }
    const idx=SONG_POOL.findIndex(p=>p.musical===origMusical&&p.song===origSong);
    if(idx!==-1){SONG_POOL[idx].musical=newMusical;SONG_POOL[idx].song=newSong;}
    closeEditModal(); filterEditor();
    setTimeout(()=>{const row=document.getElementById('erow-'+newKey);if(row){row.style.outline='2px solid var(--rose)';setTimeout(()=>row.style.outline='',2000);}},100);
  };
  if (fbKey) {
    customSongsRef.child(fbKey).update({musical:newMusical,song:newSong}).then(doUpdate)
      .catch(e=>{errEl.textContent='Firebase error: '+e.message;errEl.style.display='block';});
  } else {
    const entry=SONG_POOL.find(p=>p.musical===origMusical&&p.song===origSong);
    const corrKey=(entry&&entry._correctionKey)||correctionsRef.push().key;
    correctionsRef.child(corrKey).set({origMusical,origSong,newMusical,newSong,correctionKey:corrKey})
      .then(doUpdate).catch(e=>{errEl.textContent='Firebase error: '+e.message;errEl.style.display='block';});
  }
}

function deleteSong() {
  const origMusical=document.getElementById('edit-original-musical').value;
  const origSong=document.getElementById('edit-original-song').value;
  const origKey=document.getElementById('edit-original-key').value;
  const fbKey=document.getElementById('edit-is-custom').value;
  if (!confirm('Delete "'+origSong+'" from '+origMusical+'? This cannot be undone.')) return;
  const idx=SONG_POOL.findIndex(p=>p.musical===origMusical&&p.song===origSong);
  if(idx!==-1) SONG_POOL.splice(idx,1);
  lyricsRef.child(origKey).remove();
  delete allLyrics[origKey];
  if (fbKey) customSongsRef.child(fbKey).remove();
  closeEditModal(); filterEditor();
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  initFirebase();
  const params=new URLSearchParams(location.search);
  const code=params.get('code');
  if (code) {
    document.getElementById('join-code').value=code.toUpperCase();
    go('screen-join');
  }
});
</script>
</body>
</html>
